<template>
  <Toast />
  <div class="bg-white shadow-md rounded-lg p-4 my-4 w-full max-w-7xl mx-auto z-0">
    <a href="/areasagro" class="">←</a>
    <div class="flex flex-col">
      <div class="text-center p-2 mt-4 lg:mb-3 mb-1">
        <p class="text-4xl font-semibold text-gray-800">Visualizador de Talhão</p>
      </div>
      <hr class="border-gray-300 mb-4">
      <MapViewer :arquivoFazenda="arquivoFazenda" :arquivoDaninha="arquivoDaninha"
        :arquivoFinalDaninha="arquivoFinalDaninha" :key="arquivoFazenda" />
    </div>
  </div>
</template>

<script setup>
import MapViewer from '@/components/MapViewer.vue';
import { onMounted, ref } from 'vue';


const TOKEN = localStorage.getItem('token')
const ID =  (!localStorage.getItem('id_visualizacao')) ? 1 : localStorage.getItem('id_visualizacao')

//***CONSTANTES de TESTES MOCKADOS */
// const fullGeoJson = '{"type": "FeatureCollection","name": "MAPA_CLASSIF_AUTOMATICA","crs": { "type": "name", "properties": { "name": "urn:ogc:def:crs:OGC:1.3:CRS84" } },"features": [{ "type": "Feature", "properties": { "MN_TL": 24, "CLASSE": "DANINHAS", "AREA_M2": 0.194 }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ -49.344077296019982, -20.645835526132164 ], [ -49.344077296019982, -20.645837466792386 ], [ -49.344088075803391, -20.645837466792386 ], [ -49.344088075803391, -20.645836289470886 ], [ -49.344077296019982, -20.645835526132164 ] ] ] ] } },{ "type": "Feature", "properties": { "MN_TL": 24, "CLASSE": "DANINHAS", "AREA_M2": 1.844 }, "geometry": { "type": "MultiPolygon", "coordinates": [ [ [ [ -49.343805106488894, -20.645837466792386 ], [ -49.343805106488894, -20.645840161738239 ], [ -49.343802411543045, -20.645840161738239 ], [ -49.343802411543045, -20.645845551629943 ], [ -49.343805106488894, -20.645845551629943 ], [ -49.343805106488894, -20.645850941521648 ], [ -49.34380780143475, -20.645850941521648 ], [ -49.34380780143475, -20.6458536364675 ], [ -49.343813191326454, -20.6458536364675 ], [ -49.343813191326454, -20.645850941521648 ], [ -49.343815886272303, -20.645850941521648 ], [ -49.343815886272303, -20.645842856684091 ], [ -49.343813191326454, -20.645842856684091 ], [ -49.343813191326454, -20.645837466792386 ], [ -49.343805106488894, -20.645837466792386 ] ] ] ] } }]}'

//Formato dos N GeoJson que em teoria vai vir do endpoint
const fullGeoJson = '{"type":"MultiPolygon","coordinates":[[[[-49.34357425,-20.64802334],[-49.34358184,-20.64905778],[-49.34358199,-20.64905929],[-49.34358242,-20.64906081],[-49.34358313,-20.64906224],[-49.34358409,-20.64906353],[-49.34358527,-20.64906464],[-49.34358641,-20.64906542],[-49.34373232,-20.64914989],[-49.34373395,-20.64915062],[-49.34373557,-20.64915103],[-49.34373681,-20.64915116],[-49.34392069,-20.64915882],[-49.34438851,-20.64920483],[-49.34494102,-20.64925855],[-49.34494137,-20.64925858],[-49.3461613,-20.6493353],[-49.34692071,-20.64941201],[-49.3473043,-20.64945804],[-49.34730474,-20.64945808],[-49.34912327,-20.6495962],[-49.35002096,-20.64968827],[-49.350022,-20.64968832],[-49.35002367,-20.64968819],[-49.35002529,-20.64968778],[-49.3500268,-20.64968711],[-49.35002817,-20.64968621],[-49.35002935,-20.6496851],[-49.35003031,-20.64968381],[-49.3500309,-20.64968267],[-49.35009942,-20.64952268],[-49.35009995,-20.64952152],[-49.35010008,-20.64952123],[-49.35010052,-20.64951971],[-49.35010066,-20.64951814],[-49.35010066,-20.64941839],[-49.35010052,-20.64941682],[-49.35010038,-20.64941621],[-49.35006219,-20.64927111],[-49.35004691,-20.64910299],[-49.3500468,-20.64910217],[-49.34989333,-20.64831183],[-49.34971684,-20.64729126],[-49.34971648,-20.6472899],[-49.34947088,-20.64659916],[-49.34947067,-20.64659863],[-49.34930952,-20.64623797],[-49.34930898,-20.64623695],[-49.34930803,-20.64623566],[-49.34930684,-20.64623455],[-49.34930547,-20.64623365],[-49.34930396,-20.64623298],[-49.34930234,-20.64623258],[-49.34930163,-20.64623248],[-49.34816581,-20.64612504],[-49.34372261,-20.64581041],[-49.34372189,-20.64581038],[-49.34369119,-20.64581038],[-49.34368953,-20.64581052],[-49.34368791,-20.64581093],[-49.3436864,-20.64581159],[-49.34368503,-20.6458125],[-49.34368384,-20.64581361],[-49.34368288,-20.6458149],[-49.34368241,-20.64581578],[-49.34362869,-20.64593089],[-49.34362846,-20.64593143],[-49.34362803,-20.64593295],[-49.34362789,-20.6459343],[-49.34357426,-20.6480202],[-49.34357417,-20.64802167],[-49.34357425,-20.64802334]],[[-49.34560602,-20.64846531],[-49.34555597,-20.64848947],[-49.34553058,-20.64848609],[-49.34549392,-20.6484668],[-49.34549252,-20.64846619],[-49.34549091,-20.64846579],[-49.34548924,-20.64846565],[-49.34548757,-20.64846579],[-49.3454864,-20.64846605],[-49.34543865,-20.64847998],[-49.34541015,-20.64848501],[-49.34538935,-20.64846421],[-49.34540489,-20.64841413],[-49.34543391,-20.64839706],[-49.34546776,-20.64839518],[-49.34549601,-20.64839316],[-49.34555046,-20.64838913],[-49.34557665,-20.6483866],[-49.34558964,-20.64839569],[-49.34560445,-20.64844011],[-49.34560602,-20.64846531]]],[[[-49.34934141,-20.64609344],[-49.34936888,-20.64609867],[-49.3493837,-20.64456918],[-49.34933428,-20.64451235],[-49.3491885,-20.64448764],[-49.3487042,-20.64451235],[-49.34791351,-20.64453212],[-49.34747616,-20.64452471],[-49.34719448,-20.64447282],[-49.34699434,-20.64434433],[-49.34677443,-20.64413183],[-49.34670771,-20.64398111],[-49.34666324,-20.64376367],[-49.34667559,-20.643608],[-49.34679914,-20.64301004],[-49.34686585,-20.64263941],[-49.34690539,-20.64244421],[-49.3469128,-20.64237008],[-49.34689303,-20.64234043],[-49.3468535,-20.64228113],[-49.34558098,-20.64223171],[-49.34404655,-20.64219464],[-49.34381676,-20.64219217],[-49.3437278,-20.64220453],[-49.34369321,-20.64225889],[-49.34367344,-20.64237255],[-49.34366603,-20.64272342],[-49.34369074,-20.64349928],[-49.34370062,-20.64357588],[-49.34373522,-20.64361047],[-49.34379452,-20.64362283],[-49.34385135,-20.6436673],[-49.34386864,-20.64372166],[-49.34384394,-20.64375378],[-49.34378958,-20.64376861],[-49.34374757,-20.64378838],[-49.34374016,-20.64385262],[-49.34374016,-20.64392181],[-49.34374016,-20.64400582],[-49.34374016,-20.64411701],[-49.3437451,-20.64438881],[-49.34379699,-20.64464331],[-49.34381676,-20.6447545],[-49.34385876,-20.64482863],[-49.34386123,-20.64488793],[-49.34383899,-20.64496206],[-49.34380687,-20.64499171],[-49.34378958,-20.64503618],[-49.34380147,-20.64503845],[-49.34379205,-20.64505101],[-49.34374263,-20.64514985],[-49.34370804,-20.64526351],[-49.34367838,-20.64541176],[-49.3436685,-20.64554519],[-49.34369815,-20.64564897],[-49.34376734,-20.64571815],[-49.34397489,-20.64576263],[-49.3446371,-20.64581699],[-49.34673242,-20.64595042],[-49.34762689,-20.64602455],[-49.34862019,-20.64609867],[-49.34905013,-20.64614315],[-49.34933181,-20.64613821],[-49.34934141,-20.64609344]],[[-49.34798517,-20.64560696],[-49.34799011,-20.64562673],[-49.3479827,-20.64563167],[-49.34795552,-20.64564897],[-49.34794069,-20.64565638],[-49.34789622,-20.64567121],[-49.34785915,-20.64567121],[-49.34782209,-20.64566132],[-49.34780232,-20.64563661],[-49.34779244,-20.64561438],[-49.34776032,-20.6456292],[-49.34773067,-20.64567862],[-49.34766889,-20.64568603],[-49.34759971,-20.64565638],[-49.34755029,-20.64559214],[-49.34753547,-20.64554025],[-49.34755029,-20.64548342],[-49.34763677,-20.64543153],[-49.34770349,-20.64539941],[-49.34777514,-20.64539941],[-49.34787398,-20.64541423],[-49.34793575,-20.64547106],[-49.34796787,-20.64551801],[-49.34798517,-20.64560696]]],[[[-49.34938123,-20.64433692],[-49.34940347,-20.64324972],[-49.34940841,-20.64273824],[-49.34937382,-20.64244421],[-49.34935405,-20.64240467],[-49.3493244,-20.64237749],[-49.34925027,-20.64234537],[-49.34913661,-20.6423429],[-49.34903778,-20.64233301],[-49.34883269,-20.6423256],[-49.34836075,-20.64230583],[-49.34707835,-20.64227865],[-49.34702893,-20.64229595],[-49.34699434,-20.64234537],[-49.34697704,-20.64241703],[-49.34690291,-20.64278025],[-49.34679419,-20.64338562],[-49.34675466,-20.64359318],[-49.34673983,-20.64378591],[-49.34677937,-20.6439984],[-49.34689797,-20.64419855],[-49.34708823,-20.64434927],[-49.34729579,-20.64443081],[-49.34754535,-20.64448023],[-49.34776032,-20.64448023],[-49.34809142,-20.64447035],[-49.3487042,-20.64444317],[-49.34909461,-20.64442587],[-49.34928734,-20.64439869],[-49.34938123,-20.64433692]]]],"crs":{"type":"name","properties":{"name":"EPSG:0"}}}'

const arquivoFazenda = ref()
const arquivoDaninha = ref()
const arquivoFinalDaninha = ref()
const areaAgricola = ref();

const fetchData = async () => {
  try {
    const response = await fetch(`api/areas-agricolas/${ID}/detalhes-completos`, {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + TOKEN
      }
    });
    areaAgricola.value = await response.json();
    montaGeoJson()

  } catch (error) {
    error.value = 'Erro ao carregar os dados';
  }
};

onMounted(() => {
  fetchData();
});

const montaGeoJson = () => {

  // arquivoFazenda.value = areaAgricola.value.fazenda.arquivoFazenda

  // Comentar a linha abaixo e descomentar a acima quando a api já trazer objetos Multipolygon
  arquivoFazenda.value = fullGeoJson

  var DaninhaGeoJson = '['
  var FinalDaninhaGeoJson = '['

  let talhoes = areaAgricola.value.talhao

  for (let index = 0; index < talhoes.length; index++) {

    let safras = talhoes[index].safras
    let virgula = (index > 0) ? ' , ' : ''

    for (let j = 0; j < safras.length; j++) {

      DaninhaGeoJson += virgula + safras[j].arquivoDaninha
      FinalDaninhaGeoJson += virgula + safras[j].arquivoFinalDaninha
    }
  }

  DaninhaGeoJson += ']'
  FinalDaninhaGeoJson += ']'

  arquivoDaninha.value = DaninhaGeoJson
  arquivoFinalDaninha.value = FinalDaninhaGeoJson

  // Teste para caso o geoJson da API venha com parente do tipo geometry
  // arquivoFinalDaninha.value = extrairGeometry(fullGeoJson)
}

// const extrairGeometry = (inputGeoJson) => {
//   const inputParsed = JSON.parse(inputGeoJson)
//   let outputGeoJson = '['

//   let features = inputParsed.features
//   for (let i = 0; i < features.length; i++) {

//     let virgula = (i > 0) ? ' , ' : ''
//     outputGeoJson += virgula + JSON.stringify( features[i] )
//   }
//   outputGeoJson += ']'

//   return outputGeoJson
// }

</script>